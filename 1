// ==UserScript==
// @name         MINV Autofill Logger + CAPTCHA + City StartsWith
// @namespace    Violentmonkey Scripts
// @match        https://portal.minv.sk/wps/portal/domov/ecu/ecu_elektronicke_sluzby/ecu-vysys/*
// @grant        none
// @version      1.2
// @author       -
// @description  –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —Ñ–æ—Ä–º–∏ MINV –∑ –ª–æ–≥–∞–º–∏ + —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è CAPTCHA —á–µ—Ä–µ–∑ OpenAI + –≤–∏–±—ñ—Ä –º—ñ—Å—Ç–∞ –∑–∞ startsWith
// @run-at       document-end
// ==/UserScript==

(function() {
    'use strict';

    // üîê –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    const OPENAI_API_KEY = 'sk-proj-iRXte7QBw41n495PX9tsu2KXtJLlKRT_lzDPQD2MiP1Sbzi8KMrVeLvrvZNyUrh09GxLs609hkT3BlbkFJtgjY7dSuDleG5aAbPX-05_bYa7e1xDJtKX2UFRYuUIjgLjo7ZralAvfAu1dv_WKORfNRqxM68AA';
    const USER_NAME = 'Ivan';
    const USER_SURNAME = 'Klotsbakh';
    const USER_BIRTHDATE = '11.07.2008';
    const USER_PHONE = '+421940083584';
    const USER_EMAIL = 'martjonko71@gmail.com';
    const USER_CITY = 'OCP Trenƒç√≠n'; // üü¢ –ù–∞–∑–≤–∞ –º—ñ—Å—Ç–∞ –±–µ–∑ –¥–∞—Ç–∏
    const USER_PASSPORT = 'T';
    const STEP3_SELECT_1_VALUE = '216';
    const STEP3_SELECT_2_VALUE = '245';
    const TELEGRAM_BOT_TOKEN = '8041735564:AAEOPeEFkF3RL4kdF8ZS02980WlKggTuV-EA';
    const TELEGRAM_CHAT_ID = '814270232A'; // ID –∞–±–æ username (–∑ @)

    const config = {
        typingDelayMin: 50,
        typingDelayMax: 150,
        preFieldDelayMin: 300,
        preFieldDelayMax: 800,
        postFieldDelayMin: 80,
        postFieldDelayMax: 200,
        delayedFieldJitterMin: 50,
        delayedFieldJitterMax: 250,
        waitForElementMaxAttempts: 50,
        waitForElementInterval: 200,
    };



async function sendTelegramMessage(text) {
    const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
    await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            chat_id: TELEGRAM_CHAT_ID,
            text: text,
            parse_mode: 'HTML'
        })
    }).catch(err => console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ Telegram:", err));
}

    function triggerEvents(el) {
        el.dispatchEvent(new Event('input', { bubbles: true }));
        el.dispatchEvent(new Event('change', { bubbles: true }));
        el.dispatchEvent(new Event('blur', { bubbles: true }));
    }

    function wait(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    function randomDelay(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    async function typeValue(el, value) {
        el.value = '';
        triggerEvents(el);
        await wait(randomDelay(50, 100));

        for (const char of String(value)) {
            el.value += char;
            el.dispatchEvent(new Event('input', { bubbles: true }));
            await wait(randomDelay(config.typingDelayMin, config.typingDelayMax));
        }
        triggerEvents(el);
    }

    function waitForElement(id) {
        return new Promise(resolve => {
            let attempts = 0;
            const interval = setInterval(() => {
                const el = document.getElementById(id);
                if (el) {
                    clearInterval(interval);
                    console.log(`‚úÖ –ó–Ω–∞–π–¥–µ–Ω–æ –µ–ª–µ–º–µ–Ω—Ç: ${id}`);
                    resolve(el);
                } else if (++attempts >= config.waitForElementMaxAttempts) {
                    clearInterval(interval);
                    console.warn(`‚ùå –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –µ–ª–µ–º–µ–Ω—Ç: ${id}`);
                    resolve(null);
                }
            }, config.waitForElementInterval);
        });
    }

    async function imageToBase64(img) {
        return new Promise(resolve => {
            const canvas = document.createElement("canvas");
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0);
            resolve(canvas.toDataURL("image/png"));
        });
    }

    async function recognizeCaptcha(imageDataUrl) {
        console.log("üîç –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫–∞–ø—á—ñ –≤ OpenAI...");

        const response = await fetch("https://api.openai.com/v1/chat/completions", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${OPENAI_API_KEY}`,
                "OpenAI-Beta": "assistants=v1",
                "OpenAI-Project": "proj_NtHUbQd0hgmD2cIO6zb7VRUj"
            },
            body: JSON.stringify({
                model: "gpt-4o",
                messages: [
                    {
                        role: "user",
                        content: [
                            { type: "text", text: "–©–æ –∑–æ–±—Ä–∞–∂–µ–Ω–æ –Ω–∞ —Ü—ñ–π –∫–∞–ø—á—ñ? –ù–∞–ø–∏—à–∏ –ª–∏—à–µ —Å–∏–º–≤–æ–ª–∏ –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω—å. –¶–µ –∑–∞–≤–∂–¥–∏ –º–∞–ª—ñ –∞–Ω–≥–ª—ñ–π—Å—å–∫—ñ –ª—ñ—Ç–µ—Ä–∏ —Ç–∞ —Ü–∏—Ñ—Ä–∏ —ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∑–∞–≤–∂–¥–∏ –º–∞—î 5 —Å–∏–º–≤–æ–ª—ñ–≤." },
                            { type: "image_url", image_url: { url: imageDataUrl } }
                        ]
                    }
                ],
                max_tokens: 5
            }),
        });

        const result = await response.json();
        console.log("üì© –í—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ OpenAI:", result);

let captchaText = result?.choices?.[0]?.message?.content?.trim();

if (!captchaText || captchaText.length !== 5) {
    console.warn(`‚ö†Ô∏è –ù–µ–≤—ñ—Ä–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ AI (${captchaText}). –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è '11111'`);
    captchaText = "11111";
} else {
    console.log(`‚úÖ –†–æ–∑–ø—ñ–∑–Ω–∞–Ω–æ –∫–∞–ø—á—É: ${captchaText}`);
}        return captchaText;
    }

    async function typeCaptchaLikeHuman(el, text) {
        el.focus();
        el.value = '';
        triggerEvents(el);

        for (const char of text) {
            const evt = new KeyboardEvent('keydown', { key: char, bubbles: true });
            el.dispatchEvent(evt);
            el.value += char;
            triggerEvents(el);
            await wait(100);
        }

        triggerEvents(el);
        el.blur();
        console.log("‚úÖ –ö–∞–ø—á–∞ –≤–≤–µ–¥–µ–Ω–∞ —á–µ—Ä–µ–∑ –µ–º—É–ª—è—Ü—ñ—é –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏.");
    }

    async function solveCaptcha() {
        const imgEl = await waitForElement("captchaImage");
        const inputEl = await waitForElement("answer");

        if (!imgEl || !inputEl) {
            console.warn("‚ö†Ô∏è –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –µ–ª–µ–º–µ–Ω—Ç–∏ –∫–∞–ø—á—ñ.");
            return;
        }

        const base64 = await imageToBase64(imgEl);
        const captchaResult = await recognizeCaptcha(base64);

        if (captchaResult) {
            console.log(`‚úÖ –†–æ–∑–ø—ñ–∑–Ω–∞–Ω–æ –∫–∞–ø—á—É: ${captchaResult}`);
            inputEl.focus();
            inputEl.value = '';
            await wait(100);
            await typeCaptchaLikeHuman(inputEl, captchaResult);
            inputEl.blur();
            inputEl.style.border = "2px solid lime";
            inputEl.style.backgroundColor = "#eaffea";
            setTimeout(() => {
                inputEl.style.border = "";
                inputEl.style.backgroundColor = "";
            }, 3000);
            console.log("‚úçÔ∏è –í–≤–µ–¥–µ–Ω–æ –∫–∞–ø—á—É –≤ –ø–æ–ª–µ input#answer");
        } else {
            console.warn("‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è —Ä–æ–∑–ø—ñ–∑–Ω–∞—Ç–∏ –∫–∞–ø—á—É.");
        }
    }

    const delayedFields = {
        'residence-address-county-0': 2000,
        'residence-address-municipality-0': 2000,
        'residence-address-street-0': 2000,
        'fs13-0-travel-doc-type': 500,
        's42-check-gdpr-info': 1000,
        'submitter1': 650,
    };

    const step1Fields = [
        ['fs3-name-10', USER_NAME, 'text'],
        ['fs1-surname-10', USER_SURNAME, 'text'],
        ['fs7-date-of-birth0', async (el) => {
            el.focus(); await wait(100);
            el.value = USER_BIRTHDATE; triggerEvents(el);
            await wait(200);
            for (let i = 0; i < 10; i++) {
                el.dispatchEvent(new KeyboardEvent('keydown', { key: 'ArrowLeft', bubbles: true }));
                el.dispatchEvent(new KeyboardEvent('keyup', { key: 'ArrowLeft', bubbles: true }));
                await wait(50);
            }
            for (let i = 0; i < 2; i++) {
                el.dispatchEvent(new KeyboardEvent('keydown', { key: 'Delete', bubbles: true }));
                el.dispatchEvent(new KeyboardEvent('keyup', { key: 'Delete', bubbles: true }));
                await wait(50);
            }
            triggerEvents(el);
        }, 'custom'],
        ['s41-delivery-phone-captcha', USER_PHONE, 'text'],
        ['email0', USER_EMAIL, 'text'],
        ['loadSecondFormButton', (el) => el.click(), 'custom'],
    ];

    const step2Fields = [
        // üü¢ –ó–∞–º—ñ—Å—Ç—å —Ç–æ—á–Ω–æ–≥–æ ID ‚Äî –≤–∏–±—ñ—Ä –ø–µ—Ä—à–æ–≥–æ, —â–æ –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –Ω–∞ –º—ñ—Å—Ç–æ
        [USER_CITY, true, 'radio'],
        ['s42-check-gdpr-info', true, 'checkbox'],
        ['fs13-0-travel-doc-type', "1", 'select'],
        ['fs13-travel-doc-number', USER_PASSPORT, 'text'],
        ['submitter1', null, 'click'],
    ];

    async function fillFields(fields, label) {
        for (const [id, value, type] of fields) {
            let el = document.getElementById(id);

            if (!el && type === 'radio') {
                el = [...document.querySelectorAll('input[type="radio"][name="offices"]')]
                    .find(el => el.id && el.id.startsWith(id));
                if (el) console.log(`üéØ –ó–Ω–∞–π–¥–µ–Ω–æ –º—ñ—Å—Ç–æ –∑–∞ startsWith: ${el.id}`);
            }

            if (!el) continue;

            let preDelay = delayedFields[id]
                ? delayedFields[id] + randomDelay(config.delayedFieldJitterMin, config.delayedFieldJitterMax)
                : randomDelay(config.preFieldDelayMin, config.preFieldDelayMax);

            await wait(preDelay);
            el.focus();
            await wait(randomDelay(50, 150));

            try {
                switch (type) {
                    case 'text': await typeValue(el, value); break;
                    case 'select': el.value = value; triggerEvents(el); break;
                    case 'checkbox': el.checked = Boolean(value); triggerEvents(el); break;
                    case 'click': el.click(); break;
                    case 'custom': await value(el); break;
                    case 'radio': el.checked = true; triggerEvents(el); break;
                }
            } catch (e) {
                console.error(`[${label}] Error: ${id}`, e);
            }

            await wait(randomDelay(config.postFieldDelayMin, config.postFieldDelayMax));
        }
    }

    (async () => {
        console.log("üöÄ –°—Ç–∞—Ä—Ç –∞–≤—Ç–æ–∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è");
        await wait(randomDelay(800, 1500));
        await solveCaptcha();
        await fillFields(step1Fields, '[Step 1]');

        const triggerStep2Button = await waitForElement('f1-life-situation-select2');
        if (!triggerStep2Button) {
            console.error('‚ùå –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ select –¥–ª—è –º—ñ—Å—Ç');
            return;
        }

        triggerStep2Button.addEventListener('change', async () => {
            await wait(randomDelay(1700, 2500));
            await fillFields(step2Fields, '[Step 2]');
            console.log("‚úÖ –ö—Ä–æ–∫ 2 –∑–∞–≤–µ—Ä—à–µ–Ω–æ");



                    await wait(1500);

//                    const matchingSlot = [...document.querySelectorAll('input[type="radio"][name="offices"]')]
//                        .find(el => el.id && el.id.startsWith(USER_CITY) && el.offsetParent !== null && !el.disabled);

const matchingSlot = [...document.querySelectorAll('input[type="radio"][name="offices"]')]
    .find(el =>
        el.id &&
//        el.id.startsWith(USER_CITY) &&
        el.id.includes(USER_CITY) &&
        el.offsetParent !== null &&
        !el.disabled
    );

                    if (matchingSlot) {
                        matchingSlot.click();

                        let timeInfo = '–Ω–µ–≤—ñ–¥–æ–º–æ';
                        const label = document.querySelector(`label[for="${matchingSlot.id}"]`);
                        if (label) {
                            const match = label.textContent.match(/\d{2}:\d{2}/);
                            if (match) {
                                timeInfo = match[0];
                            }
                        }

                        console.log("‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–±—Ä–∞–Ω–æ —Ç–µ—Ä–º—ñ–Ω:", matchingSlot.id);

                        // üïí –û—Ç—Ä–∏–º—É—î–º–æ —á–∞—Å
                        const now = new Date().toLocaleString();
                        // üì© –§–æ—Ä–º—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
//                        const message = `üïí ${now}\nüìç ${USER_CITY}\nüÜî ${matchingSlot.id}\n‚û°Ô∏è ${STEP3_SELECT_1_VALUE} --> ${STEP3_SELECT_2_VALUE}`;
const message = `üïí ${now}
üìç ${USER_CITY}
üÜî ${matchingSlot.id}
‚è∞ ${timeInfo}
‚û°Ô∏è ${STEP3_SELECT_1_VALUE} --> ${STEP3_SELECT_2_VALUE}`;
                        await sendTelegramMessage(message);
                    } else {
                        console.log("‚ùå –¢–µ—Ä–º—ñ–Ω –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –¥–ª—è –º—ñ—Å—Ç–∞:", USER_CITY);
                    }


        }, { once: true });



        const pinCodeEl = await waitForElement("pin-code");
        if (pinCodeEl) {
            pinCodeEl.addEventListener('input', async () => {
                console.log("üì® PIN-–∫–æ–¥ –≤–≤–µ–¥–µ–Ω–æ, –æ—á—ñ–∫—É—î–º–æ 10 —Å–µ–∫—É–Ω–¥...");
                await wait(10000);

                const select1 = document.getElementById("f1-life-situation-select1");
                const option1 = select1?.querySelector(`option[value="${STEP3_SELECT_1_VALUE}"]`);
                if (option1) {
                    option1.selected = true;
                    select1.dispatchEvent(new Event('input', { bubbles: true }));
                    select1.dispatchEvent(new Event('change', { bubbles: true }));
                    console.log("‚úÖ –í–∏–±—Ä–∞–Ω–æ –ø–µ—Ä—à–µ –ø–æ–ª–µ f1-life-situation-select1");
                }

                await wait(2000);

                const select2 = document.getElementById("f1-life-situation-select2");
                const option2 = select2?.querySelector(`option[value="${STEP3_SELECT_2_VALUE}"]`);
                if (option2) {
                    option2.selected = true;
                    select2.dispatchEvent(new Event('input', { bubbles: true }));
                    select2.dispatchEvent(new Event('change', { bubbles: true }));
                    console.log("‚úÖ –í–∏–±—Ä–∞–Ω–æ –¥—Ä—É–≥–µ –ø–æ–ª–µ f1-life-situation-select2");
                }

                await wait(1000);

//                const finalBtn = document.getElementById("submitter1");
//                if (finalBtn) {
//                    finalBtn.click();
//                    console.log("üöÄ –ù–∞—Ç–∏—Å–Ω—É—Ç–æ –∫–Ω–æ–ø–∫—É submitter1");
//                }
            }, { once: true });
        }

        console.log("üìù –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –≤–∏–±–æ—Ä—É –º—ñ—Å—Ç–∞...");
    })();
})();
